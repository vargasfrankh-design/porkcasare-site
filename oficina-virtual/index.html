<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oficina Virtual - PorkCasare</title>
  <link rel="stylesheet" href="css/style.css" />
<style>
/* Loading overlay styles */
#page-loading-overlay {
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, rgba(10,11,13,0.65), rgba(20,22,23,0.65));
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  opacity: 1;
  transition: opacity 300ms ease, visibility 300ms ease;
  visibility: visible;
  backdrop-filter: blur(4px) saturate(120%);
  -webkit-backdrop-filter: blur(4px) saturate(120%);
}

/* Hidden state */
#page-loading-overlay.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

/* Card */
#page-loading-overlay .loader-card {
  background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
  border-radius: 14px;
  padding: 22px 28px;
  display: flex;
  gap: 16px;
  align-items: center;
  box-shadow: 0 6px 30px rgba(2,6,23,0.6);
  border: 1px solid rgba(255,255,255,0.06);
  color: #fff;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* Spinner */
.loader-spinner {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  background: conic-gradient(from 0deg, rgba(255,255,255,0.12), rgba(255,255,255,0.02));
  padding: 6px;
  box-shadow: inset 0 -6px 12px rgba(0,0,0,0.25);
}
.loader-spinner .dot {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 4px solid transparent;
  border-top-color: #7be495;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Text */
.loader-text {
  display: flex;
  flex-direction: column;
}
.loader-text .title {
  font-weight: 700;
  font-size: 16px;
  letter-spacing: 0.1px;
}
.loader-text .subtitle {
  margin-top: 4px;
  font-size: 13px;
  color: rgba(255,255,255,0.85);
}

/* subtle pulse under the card */
#page-loading-overlay::after {
  content: "";
  position: absolute;
  width: 220px;
  height: 220px;
  border-radius: 50%;
  background: radial-gradient(circle at center, rgba(123,228,149,0.12), transparent 40%);
  filter: blur(12px);
  z-index: 99998;
  transform: translateY(40px);
}
</style>
</head>
<body>
<!-- Page Loading Overlay (inserted by assistant) -->
<div id="page-loading-overlay" aria-hidden="false" role="status" aria-live="polite">
  <div class="loader-card" role="presentation">
    <div class="loader-spinner" aria-hidden="true">
      <div class="dot"></div>
    </div>
    <div class="loader-text">
      <div class="title">Cargando Oficina Virtual‚Ä¶</div>
      <div class="subtitle">Estamos preparando tu espacio. Esto no deber√≠a tardar mucho.</div>
    </div>
  </div>
</div>
<!-- end loading overlay -->

  <!-- Barra de navegaci√≥n -->
  <nav class="nav">
    <div class="brand">
      <img src="/images/logo.webp" alt="PorkCasare" class="logo" />
      <h2>PorkCasare</h2>
    </div>
    <div class="nav-actions">
      <button id="toggleDarkMode" class="btn small">üåô</button>
      <button id="logoutBtn" class="btn btn-logout">Cerrar sesi√≥n</button>
    </div>
  </nav>

  <!-- Alerta de activaci√≥n -->
  <div id="activationAlert" class="activation-alert" style="display:none;">
    ‚ö†Ô∏è Debes realizar una compra m√≠nima de 50 puntos para activar tu c√≥digo y comenzar a recibir bonos y pagos.
  </div>
  
  <!-- Contenido principal -->
  <div class="container">
    <div class="card">
      <div class="foto-perfil">
        <img id="profileImg" src="../images/avatars/avatar1.png" alt="Avatar actual">
        <div class="avatar-options" id="avatarOptions">
          <p>Selecciona tu avatar:</p>
          <div class="avatar-grid">
            <img src="../images/avatars/avatar1.png" data-avatar="avatar1.png" alt="Avatar 1" />
            <img src="../images/avatars/avatar2.png" data-avatar="avatar2.png" alt="Avatar 2" />
            <img src="../images/avatars/avatar3.png" data-avatar="avatar3.png" alt="Avatar 3" />
            <img src="../images/avatars/avatar4.png" data-avatar="avatar4.png" alt="Avatar 4" />
            <img src="../images/avatars/avatar5.png" data-avatar="avatar5.png" alt="Avatar 5" />
            <img src="../images/avatars/avatar6.png" data-avatar="avatar6.png" alt="Avatar 6" />
            <img src="../images/avatars/avatar7.png" data-avatar="avatar7.png" alt="Avatar 7" />
            <img src="../images/avatars/avatar8.png" data-avatar="avatar8.png" alt="Avatar 8" />
            <img src="../images/avatars/avatar9.png" data-avatar="avatar9.png" alt="Avatar 9" />
          </div>
        </div>
        <button id="changeAvatarBtn" class="btn small" style="display:none; margin-top:10px;">
          Cambiar avatar
        </button>
      </div>

      <h1>Bienvenido a tu oficina virtual</h1>
      <div class="user-info">
        <p><strong>Nombre:</strong> <span id="name">Cargando...</span> <span class="label"></span></p>
        <p><strong>Email:</strong> <span id="email">Cargando...</span></p>
        <p><strong>C√≥digo:</strong> <span id="code">Cargando...</span></p>
        <p><strong>Puntos personales:</strong> <span id="points">0</span></p>
        <p><strong>Puntos grupales:</strong> <span id="teamPoints">0</span></p>

        <!-- Bloque de comisiones -->
<div class="comisiones">
  <div class="comision-item cobradas">
    <div class="comision-label">Comisiones totales cobradas</div>
    <div class="comision-value">
      <span id="totalComisionesCobradas">$ 0</span>
    </div>
  </div>

  <div class="comision-item por-cobrar">
    <div class="comision-label">Comisiones por cobrar</div>
    <div class="comision-value">
      <span id="pendingCommissions">Cargando...</span>
    </div>
  </div>

        <!-- Bloque wallet y cobrar (a√±adido para compatibilidad con js/comisiones.js) -->
<div class="wallet-section" style="margin-top:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
  <div style="display:flex; flex-direction:column;">
    <div style="font-size:0.9rem; color:#555">Saldo en wallet</div>
    <div id="walletBalance" style="font-weight:700; font-size:1rem;">$0</div>
  </div>

  <div style="display:flex; gap:8px; align-items:center;">
    <button id="btnCobrar" class="btn" disabled style="padding:8px 12px; border-radius:8px; cursor:pointer;">Cobrar</button>
    <div id="lastTxInfo" style="color:#666; font-size:0.9rem;">√öltima transacci√≥n: -</div>
  </div>
</div>
<!-- Fin bloque wallet y cobrar -->

        <!-- Link de referido -->
        <div class="history-section">
          <h2>Tu link de referido</h2>
          <div class="ref-container" style="display:flex;gap:8px;align-items:center;">
            <input type="text" id="refCode" readonly style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd" />
            <button id="copyRef" class="btn small">Copiar</button>
          </div>
          <small style="color:#666">Comparte este enlace para que el campo "Patrocinador" se autocomplete al registrar.</small>
        </div>

        <!-- Productos -->
        <div class="history-section">
          <h2>Productos disponibles</h2>
          <div id="productGrid" class="product-grid"></div>
        </div>

        <!-- Historial -->
        <div class="history-section">
          <h2>Historial</h2>
          <div id="history" class="history-list"></div>
        </div>

        <!-- Red -->
        <div class="history-section">
          <h2>Mi Red</h2>
          <div id="network-controls" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
            <div><strong>Total frontales:</strong> <span id="statFrontales">0</span></div>
            <div><strong>Total en red (6 niveles):</strong> <span id="statTotal">0</span></div>
            <div><strong>Activos este mes:</strong> <span id="statRecompra">0</span></div>
            <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
              <label for="pageSize" style="font-size:13px;color:#444;margin-right:6px;">Frontales por p√°gina:</label>
              <select id="pageSize" style="padding:6px;border-radius:6px;border:1px solid #ddd;">
                <option value="5" selected>5</option>
              </select>
              <button id="btnRefreshMap" class="btn small">Actualizar mapa</button>
            </div>
          </div>
          <div id="mapContainer">
            <div id="treeWrap" style="width:100%;height:460px;border:1px solid #eee;border-radius:6px;overflow:auto;background:#fff"></div>
            <div id="treePager" style="margin-top:10px"></div>

            <!-- Resumen / estad√≠sticas del √°rbol -->
            <div id="statsInfo" style="margin-top:10px; font-size:14px; color:#333;"></div>
          </div>
        </div>

      </div> <!-- /.user-info -->
    </div> <!-- /.card -->
  </div> <!-- /.container -->

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script type="module" src="js/distribuidor-lite.js"></script>
  <script type="module" src="js/red-unilevel.js"></script>
  <script type="module" src="js/productos.js"></script>
  <script type="module" src="/js/comisiones.js"></script>
  <script>
(function(){
  function setup(){
    const btn = document.getElementById('btnCobrar');
    if (!btn) return;
    // envolver el bot√≥n para posicionar tooltip
    let wrapBtn = btn.parentElement;
    if (!wrapBtn.classList.contains('wallet-tooltip-wrap')) {
      const wrapper = document.createElement('span');
      wrapper.className = 'wallet-tooltip-wrap';
      wrapBtn.replaceChild(wrapper, btn);
      wrapper.appendChild(btn);
      wrapBtn = wrapper;
    } else {
      wrapBtn = btn.parentElement;
    }
    // crear tooltip
    let tip = wrapBtn.querySelector('.wallet-tooltip');
    if (!tip) {
      tip = document.createElement('div');
      tip.className = 'wallet-tooltip hidden';
      tip.textContent = 'No tienes comisiones por cobrar';
      wrapBtn.appendChild(tip);
    }

    function updateTooltip(){
      if (btn.disabled) {
        tip.classList.remove('hidden');
      } else {
        tip.classList.add('hidden');
      }
    }

    updateTooltip();
    const obs = new MutationObserver(() => updateTooltip());
    obs.observe(btn, { attributes: true, attributeFilter: ['disabled'] });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setup);
  } else {
    setup();
  }
})();
</script>

<script>

<!-- Loading overlay control ‚Äî enhanced: waits for avatar-grid or hides quickly for default avatars -->
<script>
/* Loading overlay control ‚Äî version improved to wait for avatar-grid hiding */
(function () {
  const overlayId = 'page-loading-overlay';
  const overlay = document.getElementById(overlayId);

  window.showPageLoading = function(message) {
    if (!overlay) return;
    overlay.classList.remove('hidden');
    overlay.setAttribute('aria-hidden', 'false');
    if (message) {
      const sub = overlay.querySelector('.loader-text .subtitle');
      if (sub) sub.textContent = message;
    }
  };

  window.hidePageLoading = function() {
    if (!overlay) return;
    overlay.classList.add('hidden');
    overlay.setAttribute('aria-hidden', 'true');
    setTimeout(() => {
      if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
    }, 400);
  };

  function isProfileUsingDefault(imgEl) {
    try {
      if (!imgEl) return true;
      const raw = imgEl.getAttribute && imgEl.getAttribute('src') ? imgEl.getAttribute('src') : (imgEl.src || '');
      const src = String(raw).split('?')[0].toLowerCase();
      if (!src) return true;
      if (src.includes('default-avatar.png')) return true;
      if (/avatar[_-]?\d+\.png$/.test(src)) return true;
      if (src.indexOf('/images/avatars/') !== -1 && /avatar\d+\.png$/.test(src)) return true;
      return false;
    } catch (e) {
      return true;
    }
  }

  function waitForAvatarGridThenHide() {
    const avatarGrid = document.querySelector('.avatar-grid') || document.getElementById('avatarGrid');
    const profileImg = document.getElementById('profileImg');
    const changeAvatarBtn = document.getElementById('changeAvatarBtn');

    if (!avatarGrid) {
      setTimeout(() => window.hidePageLoading(), 120);
      return;
    }

    if (isProfileUsingDefault(profileImg)) {
      setTimeout(() => window.hidePageLoading(), 120);
      return;
    }

    let observer;
    let finished = false;
    const finish = () => {
      if (finished) return;
      finished = true;
      try { if (observer) observer.disconnect(); } catch(e){}
      window.hidePageLoading();
    };

    try {
      observer = new MutationObserver(() => {
        try {
          const inDom = document.body.contains(avatarGrid);
          const style = window.getComputedStyle(avatarGrid);
          const isHidden = !inDom || (style && (style.display === 'none' || style.visibility === 'hidden' || avatarGrid.hidden));
          if (isHidden) finish();
        } catch (err) {}
      });
      observer.observe(avatarGrid, { attributes: true, attributeFilter: ['style','class','hidden'], childList: true });
    } catch (e) {
      observer = null;
    }

    let attempts = 0;
    const poll = setInterval(() => {
      attempts++;
      try {
        const inDom = document.body.contains(avatarGrid);
        const style = window.getComputedStyle(avatarGrid);
        const isHidden = !inDom || (style && (style.display === 'none' || style.visibility === 'hidden' || avatarGrid.hidden));
        if (isHidden) {
          clearInterval(poll);
          finish();
        } else if (attempts > 50) {
          clearInterval(poll);
          finish();
        }
      } catch (e) {}
    }, 250);

    if (changeAvatarBtn) {
      changeAvatarBtn.addEventListener('click', () => {
        setTimeout(() => {
          try {
            const style = window.getComputedStyle(avatarGrid);
            if (style.display === 'none' || avatarGrid.hidden) finish();
          } catch (e) {}
        }, 220);
      });
    }

    setTimeout(() => {
      try {
        const style = window.getComputedStyle(avatarGrid);
        const isHiddenNow = !document.body.contains(avatarGrid) || (style && (style.display === 'none' || style.visibility === 'hidden' || avatarGrid.hidden));
        if (!isHiddenNow) {
          finish();
        }
      } catch (e) {
        finish();
      }
    }, 12000);
  }

  window.addEventListener('load', function () {
    try {
      const avatarGrid = document.querySelector('.avatar-grid') || document.getElementById('avatarGrid');
      const profileImg = document.getElementById('profileImg');

      if (!avatarGrid || isProfileUsingDefault(profileImg)) {
        setTimeout(() => window.hidePageLoading(), 260);
      } else {
        waitForAvatarGridThenHide();
      }
    } catch (e) {
      setTimeout(() => window.hidePageLoading(), 800);
    }
  });

  window.onMapReady = function() {
    try { window.hidePageLoading(); } catch(e) { 
      const ov = document.getElementById('page-loading-overlay'); if (ov) ov.classList.add('hidden');
    }
  };

  setTimeout(() => {
    const ov = document.getElementById(overlayId);
    if (ov && !ov.classList.contains('hidden')) {
      try { window.hidePageLoading(); } catch(e) { ov.classList.add('hidden'); }
    }
  }, 18000);
})();
</script>


<script>
/* Loading overlay control ‚Äî versi√≥n robusta: busca el elemento din√°micamente + fallback forzoso */
(function () {
  const overlayId = 'page-loading-overlay';

  function getOverlay() {
    return document.getElementById(overlayId);
  }

  function forceRemoveOverlay(ov) {
    try {
      if (!ov) return;
      // Quitar transiciones para evitar parpadeo y forzar ocultado
      ov.style.transition = 'none';
      ov.style.opacity = '0';
      ov.style.visibility = 'hidden';
      ov.style.pointerEvents = 'none';
      // Forzar display none despu√©s de 80ms
      setTimeout(() => {
        try { if (ov && ov.parentNode) ov.parentNode.removeChild(ov); } catch(e){}
      }, 80);
    } catch(e) { console.debug('[page-loading] forceRemoveOverlay failed', e); }
  }

  window.showPageLoading = function(message) {
    const overlay = getOverlay();
    if (!overlay) {
      console.debug('[page-loading] showPageLoading: overlay no encontrado');
      return;
    }
    overlay.classList.remove('hidden');
    overlay.setAttribute('aria-hidden', 'false');
    overlay.style.display = ''; // revert any forced display:none
    if (message) {
      const sub = overlay.querySelector('.loader-text .subtitle');
      if (sub) sub.textContent = message;
    }
  };

  window.hidePageLoading = function() {
    const overlay = getOverlay();
    if (!overlay) {
      console.debug('[page-loading] hidePageLoading: overlay no encontrado (buscar fallback)');
      const ov = document.getElementById(overlayId);
      if (ov) forceRemoveOverlay(ov);
      return;
    }
    try {
      // A√±adir clase para animaci√≥n si existe CSS
      overlay.classList.add('hidden');
      overlay.setAttribute('aria-hidden', 'true');
      // Despu√©s de la transici√≥n, remover; pero tambi√©n forzar como fallback
      setTimeout(() => {
        const ov = getOverlay();
        if (ov && ov.parentNode) ov.parentNode.removeChild(ov);
      }, 400);
      // Fallback r√°pido
      setTimeout(() => forceRemoveOverlay(overlay), 500);
    } catch(e) {
      console.warn('[page-loading] hidePageLoading error', e);
      forceRemoveOverlay(overlay);
    }
  };

  // Fallback final: si la p√°gina termina de cargar y a√∫n se ve el overlay, forzarlo
  window.addEventListener('load', function () {
    try {
      const ov = getOverlay();
      if (ov && !ov.classList.contains('hidden')) {
        console.debug('[page-loading] load event: overlay still visible ‚Äî forcing removal');
        forceRemoveOverlay(ov);
      }
    } catch(e) { console.debug('[page-loading] load handler failed', e); }
  }, { once: true });

  // Mantener el timeout de seguridad existente (ejemplo: 18s)
  setTimeout(() => {
    const ov = getOverlay();
    if (ov && !ov.classList.contains('hidden')) {
      try { window.hidePageLoading(); } catch(e) { forceRemoveOverlay(ov); }
    }
  }, 18000);

})();
</script>

<!-- PATCH: mejoras de visualizaci√≥n de red (nivel + expander + tel√©fono/ciudad) -->
<script>
(function(){
  // Globals y configuraci√≥n
  window.NETWORK_VISIBLE_DEPTH = window.NETWORK_VISIBLE_DEPTH || 2;
  window.NETWORK_EXPANDED_NODES = window.NETWORK_EXPANDED_NODES || new Set();
  window.LAST_NETWORK_TREE = window.LAST_NETWORK_TREE || null;
  window.NAV_STACK = window.NAV_STACK || [];

  function _getPhoneFromNode(data){
    if(!data) return '';
    return data.telefono || data.phone || data.celular || data.phoneNumber || data.tel || '';
  }
  function _getCityFromNode(data){
    if(!data) return '';
    return data.ciudad || data.city || data.localidad || data.location || '';
  }

  // Crear / reutilizar info card
  window.createInfoCard = window.createInfoCard || function createInfoCard(){
    var mount = document.getElementById('network-info-card');
    if (mount) return mount;
    mount = document.createElement('div');
    mount.id = 'network-info-card';
    mount.style.position = 'absolute';
    mount.style.right = '18px';
    mount.style.top = '12px';
    mount.style.minWidth = '240px';
    mount.style.maxWidth = '320px';
    mount.style.zIndex = 9999;
    mount.style.background = 'white';
    mount.style.borderRadius = '8px';
    mount.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
    mount.style.padding = '12px';
    mount.style.fontFamily = 'Arial, Helvetica, sans-serif';
    mount.style.display = 'none';
    mount.innerHTML = `
      <h4 id="ic-name" style="margin:0 0 8px 0;font-size:16px;"></h4>
      <p id="ic-user" style="margin:0 0 6px 0;color:#666;font-size:13px;"></p>
      <p id="ic-phone" style="margin:0 0 6px 0;"><strong>Tel√©fono:</strong> <span id="ic-phone-value">‚Äî</span></p>
      <p id="ic-city" style="margin:0 0 6px 0;"><strong>Ciudad:</strong> <span id="ic-city-value">‚Äî</span></p>
      <p style="margin:0 0 6px 0;"><strong>Estado:</strong> <span id="ic-state"></span></p>
      <p style="margin:0 0 6px 0;"><strong>Puntos:</strong> <span id="ic-points"></span></p>
      <div style="margin-top:8px; text-align:right;">
        <button id="ic-view-network" class="btn" style="margin-right:8px;padding:6px 8px;font-size:13px;">Ver red</button>
        <button id="ic-close" class="btn" style="padding:6px 8px;font-size:13px;">Cerrar</button>
      </div>
    `;
    document.body.appendChild(mount);

    mount.querySelector('#ic-close').addEventListener('click', function(){
      mount.style.display = 'none';
    });

    mount.querySelector('#ic-view-network').addEventListener('click', async function(){
      var userId = mount.getAttribute('data-userid');
      if(!userId) return;
      if(typeof window.buildUnilevelTree === 'function'){
        try{
          var tree = await window.buildUnilevelTree(userId);
          if(tree && typeof window.renderTree === 'function'){
            window.NAV_STACK.push(userId);
            window.renderTree(tree);
          }
        }catch(e){
          console.error('Error al construir red del usuario:', e);
          alert('No se pudo cargar la red del usuario');
        }
      } else {
        alert('Funci√≥n de construcci√≥n de red no disponible.');
      }
    });

    return mount;
  };

  // Mostrar info del nodo en la tarjeta
  window.showInfoCard = window.showInfoCard || function showInfoCard(node, event){
    var el = window.createInfoCard();
    if(!el) return;
    var data = node;
    if(node && node.data) data = node.data;
    var name = data && (data.nombre || data.name || data.usuario || data.username || data.displayName) || '‚Äî';
    var user = data && (data.usuario || data.username || data.id) || (data && data.id) || '‚Äî';
    var phone = _getPhoneFromNode(data) || '‚Äî';
    var city = _getCityFromNode(data) || '‚Äî';
    var active = (data && (data.active !== undefined ? data.active : (data.estado || data.status))) ? 'Activo' : 'Inactivo';
    var puntos = (data && (data.puntos || data.points || data.personalPoints)) || 0;

    el.style.display = 'block';
    el.setAttribute('data-userid', data && (data.id || data.usuario || data.userId || data.uid) || '');
    el.querySelector('#ic-name').textContent = name;
    el.querySelector('#ic-user').textContent = user;
    el.querySelector('#ic-phone-value').textContent = phone;
    el.querySelector('#ic-city-value').textContent = city;
    el.querySelector('#ic-state').textContent = active;
    el.querySelector('#ic-points').textContent = puntos;

    try{
      if(event && event.clientX !== undefined && event.clientY !== undefined){
        var x = event.clientX + 12;
        var y = event.clientY + 12;
        var rectW = el.offsetWidth || 280;
        var rectH = el.offsetHeight || 160;
        if(x + rectW > window.innerWidth - 12) x = window.innerWidth - rectW - 12;
        if(y + rectH > window.innerHeight - 12) y = window.innerHeight - rectHeight - 12;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.style.position = 'fixed';
      } else {
        el.style.position = 'absolute';
        el.style.right = '18px';
        el.style.top = '12px';
      }
    }catch(e){}
  };

  // Reemplazo de renderTree (intento no romper si ya existe)
  window.renderTree = window.renderTree || function renderTree(rootNode) {
    var treeWrap = document.getElementById("treeWrap") || document.body;
    window.LAST_NETWORK_TREE = rootNode;
    window.NAV_STACK = window.NAV_STACK || [];

    // barra de breadcrumbs y controles de nivel
    var bc = document.getElementById('network-breadcrumbs');
    if(!bc){
      bc = document.createElement('div');
      bc.id = 'network-breadcrumbs';
      bc.style.position = 'absolute';
      bc.style.left = '12px';
      bc.style.top = '12px';
      bc.style.zIndex = 9998;
      bc.style.background = 'rgba(255,255,255,0.95)';
      bc.style.padding = '6px 10px';
      bc.style.borderRadius = '8px';
      bc.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
      bc.style.fontSize = '13px';
      bc.style.display = 'flex';
      bc.style.alignItems = 'center';
      bc.style.gap = '8px';
      bc.style.flexWrap = 'wrap';
      treeWrap.style.position = treeWrap.style.position || 'relative';
      treeWrap.appendChild(bc);
    }
    bc.innerHTML = '';

    if(window.NAV_STACK.length > 0){
      var back = document.createElement('button');
      back.textContent = '‚Üê Volver';
      back.className = 'btn';
      back.style.padding = '6px 8px';
      back.style.fontSize = '13px';
      back.addEventListener('click', function(){
        var last = window.NAV_STACK.pop();
        if(!last) return;
        if(typeof window.buildUnilevelTree === 'function'){
          window.buildUnilevelTree(last).then(function(t){
            if(t && typeof window.renderTree === 'function') window.renderTree(t);
          }).catch(function(e){ console.error(e); alert('Error al volver'); });
        }
      });
      bc.appendChild(back);
    }

    var path = document.createElement('div');
    path.style.fontWeight = '600';
    path.textContent = (window.NAV_STACK.length ? window.NAV_STACK.join(' > ') + ' > ' : '') + (rootNode && (rootNode.usuario || rootNode.name || rootNode.id) || 'Root');
    bc.appendChild(path);

    // controles Nivel 1..6
    var controls = document.createElement('div');
    controls.style.display = 'flex';
    controls.style.gap = '6px';
    controls.style.marginLeft = '8px';
    var DEPTH_LIMIT = 6;
    for(var i=1;i<=DEPTH_LIMIT;i++){
      (function(level){
        var btn = document.createElement('button');
        btn.textContent = 'Nivel ' + level;
        btn.className = 'btn network-level-btn';
        btn.style.padding = '6px 8px';
        btn.style.fontSize = '12px';
        if(window.NETWORK_VISIBLE_DEPTH === level){
          btn.style.background = '#2b9df3';
          btn.style.color = '#fff';
        }
        btn.addEventListener('click', function(){
          window.NETWORK_VISIBLE_DEPTH = level;
          if(window.LAST_NETWORK_TREE && typeof window.renderTree === 'function'){
            window.renderTree(window.LAST_NETWORK_TREE);
          }
        });
        controls.appendChild(btn);
      })(i);
    }
    bc.appendChild(controls);

    // limpiar svg actual
    var oldSvg = treeWrap.querySelector('svg');
    if(oldSvg) oldSvg.remove();

    var d3g = (typeof d3 !== 'undefined') ? d3 : null;
    if(!d3g){
      // fallback lista
      var list = document.createElement('div');
      list.style.padding = '12px';
      list.style.maxHeight = (treeWrap.clientHeight || 400) + 'px';
      list.style.overflow = 'auto';
      treeWrap.appendChild(list);
      var q = [ { node: rootNode, depth: 0 } ];
      while(q.length){
        var item = q.shift();
        if(item.depth > window.NETWORK_VISIBLE_DEPTH) continue;
        var line = document.createElement('div');
        line.style.margin = '6px 0';
        line.textContent = (new Array(item.depth+1).join('  ')) + (item.node && (item.node.usuario || item.node.nombre || item.node.id) || '‚Äî');
        line.style.cursor = 'pointer';
        line.addEventListener('click', function(ev){
          window.showInfoCard(item.node, ev);
        });
        list.appendChild(line);
        if(item.node && item.node.children && item.node.children.length){
          for(var k=0;k<item.node.children.length;k++){
            q.push({ node: item.node.children[k], depth: item.depth+1 });
          }
        }
      }
      return;
    }

    // D3 layout
    var contW = Math.max(treeWrap.clientWidth || 800, 600);
    var contH = Math.max(treeWrap.clientHeight || 600, 400);
    var margin = { top: 20, right: 20, bottom: 20, left: 20 };
    var width = contW - margin.left - margin.right;
    var height = contH - margin.top - margin.bottom;

    var svg = d3g.select(treeWrap)
      .append('svg')
      .attr('viewBox', '0 0 ' + contW + ' ' + contH)
      .attr('preserveAspectRatio','xMidYMin meet')
      .style('width','100%')
      .style('height','100%')
      .style('display','block')
      .style('touch-action','manipulation');

    var defs = svg.append('defs');
    var filter = defs.append('filter').attr('id','node-drop').attr('x','-50%').attr('y','-50%').attr('width','200%').attr('height','200%');
    filter.append('feDropShadow').attr('dx',0).attr('dy',3).attr('stdDeviation',4).attr('flood-color','#000').attr('flood-opacity',0.18);

    var g = svg.append('g').attr('transform','translate(' + margin.left + ',' + margin.top + ')');

    var zoom = d3g.zoom().scaleExtent([0.4,2]).on('zoom', function(event){ g.attr('transform', event.transform); });
    svg.call(zoom).call(zoom.transform, d3g.zoomIdentity.translate(margin.left, margin.top));
    svg.on('dblclick.zoom', null);

    var root = d3g.hierarchy(rootNode, function(d){ return d.children || []; });
    var treeLayout = d3g.tree().size([width, height - 40]);
    treeLayout(root);

    try {
      var TOP_MARGIN = 60;
      var shiftX = (width / 2) - root.x;
      var shiftY = TOP_MARGIN - root.y;
      root.each(function(d){ d.x = d.x + shiftX; d.y = d.y + shiftY; });
    } catch(e){}

    function isNodeVisible(d){
      if(!d) return false;
      if(d.depth <= (window.NETWORK_VISIBLE_DEPTH || 2)) return true;
      var expanded = window.NETWORK_EXPANDED_NODES || new Set();
      var cur = d;
      while(cur){
        if(cur.data && expanded.has(cur.data.id)) return true;
        cur = cur.parent;
      }
      return false;
    }

    var links = root.links();
    var link = g.selectAll('.link').data(links).enter().append('path')
      .attr('class','link-line')
      .attr('d', function(d){
        var sx = d.source.x;
        var sy = d.source.y;
        var tx = d.target.x;
        var ty = d.target.y;
        return 'M' + sx + ',' + (sy + 30) + ' C ' + sx + ',' + ((sy+ty)/2) + ' ' + tx + ',' + ((sy+ty)/2) + ' ' + tx + ',' + (ty - 30);
      })
      .attr('fill','none').attr('stroke','#d0d0d0');

    link.attr('stroke-opacity',0).transition().duration(600).attr('stroke-opacity',1);

    var node = g.selectAll('.node').data(root.descendants()).enter().append('g')
      .attr('class', function(d){ return 'node depth-' + d.depth; })
      .attr('transform', function(d){ return 'translate(' + d.x + ',' + d.y + ')'; })
      .style('cursor','pointer')
      .style('touch-action','manipulation');

    node.append('circle').attr('r',40).attr('fill','transparent').attr('pointer-events','auto');

    node.append('circle')
      .attr('r', function(d){ return d.depth === 0 ? 36 : Math.max(20, 34 - d.depth*2); })
      .attr('filter','url(#node-drop)')
      .attr('fill', function(d){ return (d.data && d.data.usuario && (d.data.usuario === (rootNode.usuario || rootNode.id))) ? '#2b9df3' : (d.data && d.data.active ? '#28a745' : '#bfbfbf'); })
      .attr('stroke','#ffffff').attr('stroke-width',3).attr('pointer-events','none');

    node.append('text')
      .attr('y',6)
      .attr('text-anchor','middle')
      .attr('fill','#fff')
      .style('font-size','13px')
      .style('font-weight','700')
      .text(function(d){ var u = (d.data && (d.data.usuario || d.data.nombre || d.data.name)) || ''; return u.length > 12 ? u.slice(0,10) + '‚Ä¶' : u; });

    node.style('display', function(d){ return isNodeVisible(d) ? null : 'none'; });
    link.style('display', function(l){ return (isNodeVisible(l.source) && isNodeVisible(l.target)) ? null : 'none'; });

    node.each(function(d){
      var thisNode = d3g.select(this);
      var hasChildren = d.children && d.children.length;
      var childHidden = false;
      if(hasChildren){
        for(var i=0;i<d.children.length;i++){
          if(!isNodeVisible(d.children[i])) { childHidden = true; break; }
        }
      }
      if(hasChildren && childHidden){
        var exp = thisNode.append('g').attr('class','expander').style('cursor','pointer').attr('transform','translate(28,-28)');
        exp.append('circle').attr('r',10).attr('fill','#ffffff').attr('stroke','#2b9df3').attr('stroke-width',2);
        var sign = (window.NETWORK_EXPANDED_NODES && window.NETWORK_EXPANDED_NODES.has(d.data && d.data.id)) ? '‚àí' : '+';
        exp.append('text').attr('y',4).attr('text-anchor','middle').attr('fill','#2b9df3').style('font-size','12px').text(sign);
        exp.on('pointerup', function(ev){
          ev.stopPropagation();
          if(!window.NETWORK_EXPANDED_NODES) window.NETWORK_EXPANDED_NODES = new Set();
          var id = d.data && d.data.id;
          if(!id) return;
          if(window.NETWORK_EXPANDED_NODES.has(id)) window.NETWORK_EXPANDED_NODES.delete(id);
          else window.NETWORK_EXPANDED_NODES.add(id);
          if(window.LAST_NETWORK_TREE) window.renderTree(window.LAST_NETWORK_TREE);
        });
      }
    });

    node.each(function(d){
      var dom = this;
      var handler = function(e){
        try{ e.preventDefault(); }catch(err){}
        try{ e.stopPropagation(); }catch(err){}
        window.showInfoCard(d.data, e);
      };
      dom.addEventListener('pointerup', handler);
      dom.addEventListener('click', handler);
    });

    node.attr('opacity',0).attr('transform', function(d){ return 'translate(' + d.x + ',' + (d.y+18) + ')'; })
      .transition().duration(600).ease(d3g.easeCubic).attr('opacity',1).attr('transform', function(d){ return 'translate(' + d.x + ',' + d.y + ')'; });

    try { svg.node().getBoundingClientRect(); svg.style('display','none'); requestAnimationFrame(function(){ svg.style('display','block'); }); } catch(e){}
  };

  // Si existe buildUnilevelTree original, envolverlo para normalizar telefono/ciudad en la estructura
  if (typeof window.buildUnilevelTree === 'function') {
    var _origBuild = window.buildUnilevelTree;
    window.buildUnilevelTree = async function(rootId){
      var tree = await _origBuild(rootId);
      if(!tree) return tree;
      function walk(n){
        if(!n) return;
        if(n.data){
          if(!n.telefono) n.telefono = _getPhoneFromNode(n.data);
          if(!n.ciudad) n.ciudad = _getCityFromNode(n.data);
          if(!n.id) n.id = n.data.id || n.data.uid || n.data.usuario || n.data.userId || n.data.username;
          if(!n.nombre) n.nombre = n.data.nombre || n.data.name || n.data.usuario;
        } else {
          if(!n.telefono) n.telefono = _getPhoneFromNode(n);
          if(!n.ciudad) n.ciudad = _getCityFromNode(n);
        }
        if(n.children && n.children.length){
          for(var i=0;i<n.children.length;i++) walk(n.children[i]);
        }
      }
      walk(tree);
      return tree;
    };
  }

})(); // end IIFE
</script>
<!-- END PATCH -->
</body>
</html>
