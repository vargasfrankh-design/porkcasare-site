<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Órdenes PorkCasare</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* mínimo para la tabla */
    .container { max-width:1100px; margin:24px auto; padding:16px; }
    table { width:100%; border-collapse:collapse; margin-top:12px;}
    th, td { padding:8px; border:1px solid #e6e6e6; text-align:left; }
    .btn { padding:8px 10px; border-radius:6px; cursor:pointer; }
    .btn.confirm { background:#28a745; color:#fff; }
    .btn.reject { background:#f44336; color:#fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Panel Admin — Órdenes pendientes</h1>
    <p id="adminInfo">Cargando...</p>
    <div id="ordersWrap">
      <table id="ordersTable">
        <thead>
          <tr>
            <th>OrderId</th>
            <th>Usuario (buyerUid)</th>
            <th>Producto</th>
            <th>Precio</th>
            <th>Puntos</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="ordersBody">
        </tbody>
      </table>
    </div>
  </div>

  <script type="module" src="/src/firebase-config.js"></script>
  <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { auth } from "/src/firebase-config.js"; // si exportas auth
    import { getIdToken } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    // Ejemplo simple para obtener token y llamar la función
    const authInst = getAuth();

    onAuthStateChanged(authInst, async user => {
      if (!user) {
        document.getElementById('adminInfo').innerText = 'Debes iniciar sesión como admin.';
        return;
      }
      // Preguntar en Firestore si role === 'admin' (o confiar en función)
      document.getElementById('adminInfo').innerText = `Sesión: ${user.email} (uid: ${user.uid})`;
      // cargar órdenes
      await loadOrders();
    });

    async function loadOrders() {
      // llamamos una Netlify function que devuelve órdenes pendientes (server-side comprueba admin)
      try {
        const res = await fetch('/.netlify/functions/list-orders', { method: 'GET' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error cargando órdenes');
        renderOrders(data.orders || []);
      } catch (err) {
        console.error(err);
        document.getElementById('adminInfo').innerText = 'Error cargando órdenes: ' + err.message;
      }
    }

    function renderOrders(orders) {
      const body = document.getElementById('ordersBody');
      body.innerHTML = '';
      orders.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.id}</td>
          <td>${o.buyerUid}</td>
          <td>${o.productName}</td>
          <td>${o.price}</td>
          <td>${o.points}</td>
          <td>${o.status}</td>
          <td>
            <button class="btn confirm" data-id="${o.id}">Confirmar</button>
            <button class="btn reject" data-id="${o.id}">Rechazar</button>
          </td>
        `;
        body.appendChild(tr);
      });

      // handlers
      document.querySelectorAll('.btn.confirm').forEach(b => {
        b.addEventListener('click', async (ev) => {
          const id = ev.currentTarget.dataset.id;
          await adminAction(id, 'confirm');
        });
      });
      document.querySelectorAll('.btn.reject').forEach(b => {
        b.addEventListener('click', async (ev) => {
          const id = ev.currentTarget.dataset.id;
          await adminAction(id, 'reject');
        });
      });
    }

    async function adminAction(orderId, action) {
      try {
        // pedir ID token del usuario actual
        const user = (await import('https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js')).getAuth().currentUser;
        if (!user) { alert('No auth'); return; }
        const token = await getIdToken(user, /* forceRefresh */ true);

        const res = await fetch('/.netlify/functions/confirm-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ orderId, action })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error');
        alert(data.message || 'OK');
        await loadOrders(); // refrescar
      } catch (err) {
        console.error(err);
        alert('Error: ' + err.message);
      }
    }
  </script>
</body>
</html>
