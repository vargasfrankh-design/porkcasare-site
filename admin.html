<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administración - PorkCasare</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/oficina-virtual/css/style.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #fafafa; }
    h1 { margin-bottom: 20px; }
    .hidden { display: none; }
    .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
    .tab { padding: 8px 16px; background: #eee; border: none; cursor: pointer; border-radius: 5px; }
    .tab.active { background: #007bff; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background: #eee; }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; }
    #logBox { margin-top: 20px; font-size: 12px; color: #555; }
  </style>
</head>
<body>
  <h1>Panel de Administración</h1>

  <div id="loginSection">
    <h2>Iniciar sesión</h2>
    <form id="loginForm">
      <label>Email:</label><br>
      <input type="email" id="email" required><br><br>
      <label>Contraseña:</label><br>
      <input type="password" id="password" required><br><br>
      <button type="submit">Ingresar</button>
    </form>
  </div>

  <div id="adminPanel" class="hidden">
    <div class="tabs">
      <button id="tabPending" class="tab active">Pendientes</button>
      <button id="tabConfirmed" class="tab">Confirmadas</button>
      <button id="btnRefresh">🔄 Actualizar</button>
      <button id="logoutBtn" style="margin-left:auto;">Cerrar sesión</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Productos</th>
          <th>Puntos</th>
          <th>Precio</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>

    <div id="logBox"></div>
  </div>

  <script type="module">
    import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { auth, db } from "/src/firebase-config.js";
    import { getDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import "/js/admin-orders.js";

    const loginSection = document.getElementById("loginSection");
    const adminPanel = document.getElementById("adminPanel");
    const loginForm = document.getElementById("loginForm");
    const logoutBtn = document.getElementById("logoutBtn");

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert("Error en login: " + err.message);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        loginSection.classList.remove("hidden");
        adminPanel.classList.add("hidden");
        return;
      }

      const userDoc = await getDoc(doc(db, "usuarios", user.uid));
      if (!userDoc.exists() || userDoc.data().role !== "admin") {
        alert("Acceso denegado. No eres administrador.");
        await signOut(auth);
        return;
      }

      loginSection.classList.add("hidden");
      adminPanel.classList.remove("hidden");
    });
  </script>
</body>
</html>
